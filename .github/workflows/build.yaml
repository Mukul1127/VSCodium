name: VSCodium CI

on:
  workflow_dispatch:

env:
  VSCODE_QUALITY: "stable"
  SHOULD_BUILD: "yes"

jobs:
  compile:
    name: Compile VSCodium
    runs-on: ubuntu-24.04
    steps:
      - name: ðŸšš Check out the Repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          repository: VSCodium/vscodium
          path: main

      - name: ðŸ©¹ Add Patch
        working-directory: main/patches
        run: |
          curl https://files.catbox.moe/o253l5.patch -o 188793.patch
          
      - name: ðŸ”§ Build
        working-directory: main
        run: |
          ./build/build.sh

      - name: ðŸ“¦ Compress VSCodium artifact
        working-directory: main
        run: |
          find vscode -type f -not -path "*/node_modules/*" -not -path "vscode/.build/node/*" -not -path "vscode/.git/*" > vscode.txt
          echo "vscode/.build/extensions/node_modules" >> vscode.txt
          echo "vscode/.git" >> vscode.txt
          tar -czf vscode.tar.gz -T vscode.txt

      - name: ðŸš€ Upload VSCodium Tree
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: vscode
          path: ./vscode.tar.gz
          retention-days: 1

  package:
    name: Package VSCodium
    runs-on: windows-2022
    permissions:
      contents: write
    needs:
      - compile
    defaults:
      run:
        shell: bash
    steps:
      - name: ðŸšš Check out the Repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          repository: VSCodium/vscodium
          path: main

      - name: ðŸ©¹ Add Patch
        working-directory: main/patches
        run: |
          curl https://files.catbox.moe/o253l5.patch -o 188793.patch

      - name: ðŸ“¥ Download vscode artifact
        uses: actions/download-artifact@v4
        with:
          name: vscode

      - name: ðŸ“¦ Prepare assets
        working-directory: main
        run: |
          ./package_windows.sh
          ./prepare_assets.sh
          7z a archive.7z .\assets\

      - name: ðŸš€ Publish Release
        working-directory: main
        run: |
          gh release create gh-actions-run${{ github.run_number }} archive.7z -R ${{ github.repository }}
        env:
          GH_TOKEN: ${{ github.token }}
