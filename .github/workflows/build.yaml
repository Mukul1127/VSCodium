name: VSCodium CI

on:
  workflow_dispatch:

env:
  VSCODE_QUALITY: stable
  SHOULD_BUILD: "yes"

jobs:
  check:
    name: Check Versions
    runs-on: ubuntu-24.04
    outputs:
      MS_COMMIT: ${{ env.MS_COMMIT }}
      MS_TAG: ${{ env.MS_TAG }}
      RELEASE_VERSION: ${{ env.RELEASE_VERSION }}
      SHOULD_BUILD: ${{ env.SHOULD_BUILD }}
      SHOULD_DEPLOY: ${{ env.SHOULD_DEPLOY }}

    steps:
      - name: 🚚 Check out the Repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          repository: VSCodium/vscodium
          path: main

      - name: 📥 Download Repo
        working-directory: main
        run: |
          ./get_repo.sh

      - name: 🔍 Check PR or cron
        working-directory: main
        env:
          GENERATE_ASSETS: true
        run: |
          ./check_cron_or_pr.sh

      - name: 🔍 Check existing VSCodium tags/releases
        working-directory: main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CHECK_ALL: "yes"
        run: |
          ./check_tags.sh

  compile:
    name: Compile VSCodium
    runs-on: ubuntu-24.04
    needs:
      - check
    steps:
      - name: 🚚 Check out the Repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          repository: VSCodium/vscodium
          path: main

      - name: 🩹 Add Patch
        working-directory: main/patches
        run: |
          curl -LO https://files.catbox.moe/o253l5.patch

      - name: 💾 Install Dependencies
        run: |
          echo "None Yet!"

      - name: 📥 Download Repo
        working-directory: main
        run: |
          ./get_repo.sh

      - name: 🔧 Build
        working-directory: main
        run: |
          ./build.sh

      - name: 📦 Compress VSCodium artifact
        working-directory: main
        run: |
          find vscode -type f -not -path "*/node_modules/*" -not -path "vscode/.build/node/*" -not -path "vscode/.git/*" > vscode.txt
          echo "vscode/.build/extensions/node_modules" >> vscode.txt
          echo "vscode/.git" >> vscode.txt
          tar -czf vscode.tar.gz -T vscode.txt

      - name: 🚀 Upload VSCodium Tree
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: vscode
          path: ./vscode.tar.gz
          retention-days: 1

  package:
    name: Package VSCodium
    runs-on: windows-2022
    permissions:
      contents: write
    needs:
      - check
      - compile
    defaults:
      run:
        shell: bash
    steps:
      - name: 🚚 Check out the Repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          repository: VSCodium/vscodium
          path: main

      - name: 🩹 Add Patch
        working-directory: main/patches
        run: |
          curl -LO https://files.catbox.moe/o253l5.patch

      - name: 📥 Download vscode artifact
        uses: actions/download-artifact@v4
        with:
          name: vscode

      - name: 📦 Prepare assets
        working-directory: main
        run: |
          ./package_windows.sh
          ./prepare_assets.sh
          7z a archive.7z .\assets\

      - name: 🚀 Publish Release
        working-directory: main
        run: |
          gh release create gh-actions-run${{ github.run_number }} archive.7z -R ${{ github.repository }}
        env:
          GH_TOKEN: ${{ github.token }}
